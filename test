local module = {
    drawingcache = {},
    cache = {},
    settings = {
        enabled = true,
        refreshrate = 5,
        limitdistance = true,
        maxdistance = 2500,
        teamcheck = false,
        teamcolor = true,
        textoffset = 0,
        textfont = 0,
        textsize = 18,
        names = true,
        namesoutline = false,
        namescolor = Color3.new(1, 1, 1),
        distance = true,
        distanceoutline = false,
        distancecolor = Color3.new(1, 1, 1),
        boxes = true,
        boxesoutline = false,
        boxesfill = false,
        boxesfillcolor = Color3.new(1, 1, 1),
        boxesfilltrans = 0.5,
        boxescolor = Color3.new(1, 1, 1),
        tracers = false,
        tracerscolor = Color3.new(1, 1, 1),
        tracersorigin = "Bottom",
        healthbars = false,
        healthbarsoffset = 2,
        healthbarsoutline = false,
        healthbarscolor = Color3.new(0, 1, 0),
        
        aimtarget_on = false,
        aimtarget = nil,
        aimtarget_color = Color3.new(252, 186, 3),
    }
}

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Cache
local LocalPlayer = Players.LocalPlayer
local CurrentCamera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

function module:Create(Class, Properties)
    local Object = Drawing.new(Class)

    for i,v in pairs(Properties) do
        Object[i] = v
    end

    table.insert(self.drawingcache, Object)
    return Object
end

function module:AddEsp(Player)
    if (Player == LocalPlayer) then
        return
    end
    
    local Retainer = {}
    
    Retainer.boxobject = self:Create("Square", {
        Visible = false,
        Transparency = 1,
        Color = Color3.new(1, 1, 1),
        Thickness = 1,
        Filled = false,
    })
    local CanRun = true

    RunService:BindToRenderStep(Player.Name .. "Esp", 1, function()
        if (not CanRun) then
            return
        end

        CanRun = false

        local Character, Root = self:GetCharacter(Player)

        if (Character and Root) then
            local Health, MaxHealth = self:GetHealth(Player)
            local _, OnScreen = CurrentCamera:WorldToViewportPoint(Root.Position)
            local Magnitude = (Root.Position - CurrentCamera.CFrame.p).Magnitude
            local CanShow = OnScreen and self.settings.enabled

            if (self.settings.limitdistance and Magnitude > self.settings.maxdistance) then
                CanShow = false
            end

            if (self.settings.teamcheck and not self:CheckTeam(Player)) then
                CanShow = false
            end

            if (Health <= 0) then
                CanShow = false
            end

            if (CanShow) then
                local Data = self:GetBoundingBox(Character)
                local Width, Height = math.floor(Data.Positions.TopLeft.X - Data.Positions.TopRight.X), math.floor(Data.Positions.TopLeft.Y - Data.Positions.BottomLeft.Y)
                local BoxSize = Vector2.new(Width, Height)
                local BoxPosition = Vector2.new(math.floor(Data.Positions.BottomRight.X), math.floor(Data.Positions.BottomRight.Y))
                
                Retainer.boxobject.Visible = self.settings.boxes
                Retainer.boxobject.Size = BoxSize
                Retainer.boxobject.Position = BoxPosition
                else
                for i,v in pairs(Retainer) do
                    v.Visible = false
                end
            end
            else
            for i,v in pairs(Retainer) do
                v.Visible = false
            end
        end
        task.wait(math.clamp(5))
    end)
    self.cache[Player] = Retainer
end

function module:RemoveEsp(Player)
    local Data = self.cache[Player]

    if (Data) then
        RunService:UnbindFromRenderStep(Player.Name .. "Esp")

        for _, Object in pairs(Data) do
            Object:Remove()
        end
    end
end

function module:GetCharacter(Player)
    return Player.Character, Player.Character and Player.Character:WaitForChild("HumanoidRootPart")
end

function module:GetBoundingBox(Character)
    local Data = {}

    for i,v in pairs(Character:GetChildren()) do
        if (v:IsA("BasePart") and v.Name ~= "HumanoidRootPart") then
            for i2, v2 in pairs(Math.getpartinfo2(v.CFrame, v.Size)) do
                table.insert(Data, v2)
            end
        end
    end

    return Math.getposlist2(Data)
end
function module:GetHealth(Player)
    local Character = self:GetCharacter(Player)
    local Humanoid = Character and Character:WaitForChild("Humanoid")

    return Humanoid and Humanoid.Health, Humanoid and Humanoid.MaxHealth
end

function module:GetTeam(Player)
    return Player.Team
end

function module:CheckTeam(Player)
    return Player.Team ~= LocalPlayer.Team
end

function module:Init()
    for i,v in pairs(Players:GetPlayers()) do
        self:AddEsp(v)
    end

    Players.PlayerAdded:Connect(function(Player)
        self:AddEsp(Player)
    end)

    Players.PlayerRemoving:Connect(function(Player)
        self:AddEsp(Player)
    end)
end
return module

